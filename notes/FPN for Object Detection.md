# Feature Pyramid Networks for Object Detection

论文地址：./resources/papers/Feature Pyramid Networks for Object Detection.pdf 或 [arXiv论文链接](https://arxiv.org/abs/1612.03144)

### 一、简介

目标检测任务中，一个反复被提起，至今仍很棘手的问题，就是图片中的物体有大有小。而往往当目标物体过小时，识别会极其困难。因此首先梳理一下各种做法，下图展示了4种利用多尺度特征的形式，可以视为特征金字塔网络发展的历程：

<img src=".\img\四种特征金字塔.jpg" style="zoom:80%;" />

##### 图像金字塔

图a是最基础的特征化的图像金字塔，即将图像做成不同的scale，然后不同scale的图像生成对应的不同scale的特征。这种方法主要适用于早期的手动提取特征的分类器。在SIFT和HOG之前，早期的检测基本上都是基于图像金字塔的，之后的Overfeat采用图像金字塔上滑动窗口的方法，R-CNN采用了区域建议的方法。

##### 原始CNN

之后出现了卷积网络CNN，CNN其实就是有层次地学习图片的特征，通过一层层的池化和降采样得到深层的特征。特征提取渐渐开始通过卷积网络实现，而卷积网络对于尺度的适应性更强，因此可以直接使用一个尺度的特征图像，如图b所示。Fast R-CNN和Faster R-CNN就采用这种方式。

##### 金字塔型特征层级

但是即便是使用了卷积网络，想要的得到最精确的预测还是需要在不同尺度上进行特征化，这么做的好处是即便是在高分辨率的特征层中也是 semantically strong 的。但是这么做的问题是内存，当端对端训练深度网络时内存根本不够用，因此它不太实用。因此诞生了另一种方法：深度卷积网络逐层计算 feature hierarchy（如图c所示）。SSD的方法就是这种，直接在不同分辨率的特征上进行预测，但是问题是浅层得到的语义意义不大（SSD实际上是舍弃的），并且能够达到的最高分辨率并不高。

##### 特征金字塔网络

特征金字塔网络的提出是为了解决**兼顾分辨率与语义特征**的问题，而解决这个问题的基础是**使用一个从上到下将低分辨率的强语义特征与高分辨率的弱语义特征连接起来的基础架构，并使用横向连接**（如图d所示）。FPN的独到之处在于将深/潜层特征融合与多分辨率预测结合了起来。*FPN可以被视为是一个backbone网络，并不是完整的分类器*

### 二、Feature Pyramid Networks

FPN使用任意大小的图片输入，然后输出对应比例的不同尺度的特征图，这一过程是独立进行的（作为一个backbone）。FPN主要包含三个组件：自下而上的通路、自上而下的通路和横向连接。原文中主网络采用了ResNet。

#### 2.1 自下而上通路

或者说是自底而上通路，是FPN的第一部分，他计算不同尺度的特征图，每一级（也就是每一stage）向上用step为2的降采样。会有很多卷积层产生一样大小的的特征图，我们称其为位于同一个stage，取每个stage的最后一层的特征图输出作为该stage的输出，这些输出最终汇总获得总输出。

可以理解为就是网络的前向过程，特征图的大小经过某些层时改变，而经过其他一些层不改变，不改变的层归为一个stage，因此每次抽取的特征都是每个stage最后一层的输出。

#### 2.2 自上而下通路和横向连接

自上而下或者是自顶而下就是采用上采样，而横向连接则是将上采样的结果和自底向上生成的相同大小的feature map进行融合，在融合之后还会再采用3*3的卷积核对每个融合结果进行卷积，目的是消除上采样的混叠效应（aliasing effect）。值得注意的是，ground truth 框的尺度并没有被分配到他们的金字塔层级，而是关联到对应的anchor，而这些anchor才是被分配到金字塔层级上的。

### 三、FPN应用

#### 3.1 RPN中应用

原始RPN中是在一个单一尺寸的特征图上使用3×3的滑动窗口，详见[Faster RCNN论文](./Faster R-CNN.md/####4.2 RPN部分)。在其中应用FPN的方法是对特征金字塔的每一个级都应用一个RPN的设计（3×3的卷积层和两个并行的1×1卷积层），但是每级都只需要相同尺寸的anchor就行了。

#### 3.2 Fast R-CNN 中的应用

Fast R-CNN 是使用 RoI Pooling 来提取特征的，他也是主要基于一个单个尺度的图像的，而为了使用FPN，就需要将RoI池分配到不同的特征金字塔层级上去，这点的实现是用通过RoI的长宽公式计算得到所对应FPN层级的方式实现的。











